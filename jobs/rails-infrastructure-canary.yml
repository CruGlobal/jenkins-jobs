- job:
    builders:
    - shell: 'PROJECT_NAME=${JOB_NAME} DEPLOY_ECS=false ~/bin/rails_deploy.sh'
    description: |
      Builds a simplistic rails app,
      which only serves to prove out the ci & deployment infrastructure.

      Builds on the 'staging' branch automatically trigger a deployment
      of that image to the staging environment.

      From 7am to 1pm on weekdays, builds on the 'master' branch automatically trigger a
      deployment of that image to the production environment.

      Historic builds can be manually deployed to either staging or production,
      by running the 'Deploy to Production' or the 'Deploy to Staging' build promotions.
      (This won't work for builds that were not pushed to dockerhub --
      currently, only staging/master images get pushed to dockerhub).
    name: rails-infrastructure-canary
    parameters: []
    properties:
    - github:
        url: https://github.com/CruGlobal/fails-infrastructure-canary/
    publishers:
      - conditional-publisher:
          - condition-kind: always
# TODO: jjb doesn't seem to support strings-match here (but it does in builders)
#          - condition-kind: strings-match
#            condition-string1: "$GIT_BRANCH"
#            condition-string2: "origin/staging"
            action:
              - trigger-parameterized-builds:
                  - project: deploy-ecs
                    predefined-parameters: |
                      IMAGE_TAG=${GIT_COMMIT}-${BUILD_NUMBER}
                      PROJECT_NAME=${JOB_NAME}
                      GIT_COMMIT=${GIT_COMMIT}
                      GIT_BRANCH=${GIT_BRANCH}
                      ENVIRONMENT=staging
                      CLUSTER=lab
                    condition: SUCCESS

    scm:
    - git:
        branches:
        - $BRANCH_SPECIFIER
        url: git@github.com:CruGlobal/rails-infrastructure-canary.git
        wipe-workspace: false
    triggers:
        - github
    wrappers:
    - build-name:
        name: '${GIT_BRANCH} #${BUILD_NUMBER}'
