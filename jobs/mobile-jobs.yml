- job-template:
    name: '{name}-beta'
    node: mac
    logrotate:
      numToKeep: 5
    description: |
      {description-intro}

      Runs when pull requests are submitted to {git-branch} branch. If building and testing is successful the app will be deployed to crashlytics for beta testing.
    properties:
      - github:
          url: https://github.com/CruGlobal/{name}/
      - inject:
          properties-content: |
            #ANDROID
            ANDROID_SDK_PATH=/Volumes/External\ HD/android-sdk-macosx

            #PATH
            PATH=$PATH:/Users/Shared/Jenkins/.rbenv/shims:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/Volumes/External\ HD/android-sdk-macosx/tools:/Volumes/External\ HD/android-sdk-macosx/platform-tools

            #LANGUAGE SETTINGS (Fixes Ruby issue with Fastlane)
            LANG=en_US.UTF-8
            LANGUAGE=en_US.UTF-8
            LC_ALL=en_US.UTF-8

            GIT_BRANCH={git-branch}
            GIT_ORIGIN_BRANCH=origin/$GIT_BRANCH
    scm:
      - git:
          branches:
            - {git-branch-to-build}
          url: git@github.com:CruGlobal/{name}.git
          credentials-id: '66c3b5a3-0f7c-4e22-97b2-a78fb5a73658'
          refspec: {git-fetch-filter-refspec}
          wipe-workspace: false
          skip-tag: true
          prune: true
          excluded-users:
            - cru-jenkins-mobile
            - cru-jenkins2
            - cru-jenkins
    wrappers:
      - build-name:
          name: '$GIT_ORIGIN_BRANCH #$BUILD_NUMBER'
      - ssh-agent-credentials:
          users:
            - '66c3b5a3-0f7c-4e22-97b2-a78fb5a73658'
      - ansicolor:
          colormap: xterm
    builders:
      - shell: |
          #!/usr/bin/env bash
          set +x
          diffContent=$(git diff $GIT_ORIGIN_BRANCH^ $GIT_ORIGIN_BRANCH)
          diffSearchString="fastlane[^/metadata]\|FASTLANE_USER\|FASTLANE_PASSWORD\|FASTLANE_DONT_STORE_PASSWORD\|FASTLANE_TEAM_ID\|CODE_SIGNING_IDENTITY\|CERT_PASSWORD\|KEYCHAIN_NAME|\KEYCHAIN_PASSWORD\|DELIVER_PASSWORD\|DELIVER_USER"
          RED_COLOR='\033[0;31m'
          NO_COLOR='\033[0m'
          echo "$diffContent" | grep -q $diffSearchString
          set -x
          if [ $? -eq 0 ]; then
            echo -e "$RED_COLOR" "Unfortunately you do not have permission to change build scripts. Contact your system admin if you think you should be able to run this build." "$NO_COLOR"
            exit 1
          else
            exit 0
          fi
      - shell: |
          bundle install
          bundle exec fastlane beta --env beta