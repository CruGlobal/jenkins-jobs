- project:
    name: godtools-swift
    description-intro: Builds, tests, & deploys the New Godtools iOS App.
    email-recipients: michael.harrison@cru.org
    crashlytics-group-default: god-tools-ios
    jobs:
        - '{name}-beta'
        - '{name}-production'

- job-template:
    name: '{name}-beta'
    node: mac
    logrotate:
      numToKeep: 5
    description: |
      {description-intro}

      Runs when pull requests are submitted to develop branch. If building and testing is successful the app will be deployed to crashlytics for beta testing.
    parameters:
      - string:
          name: CRASHLYTICS_GROUP
          default: '{crashlytics-group-default}'
          description: Alias of Crashlytics group to receive beta build
    properties:
      - github:
          url: https://github.com/CruGlobal/{name}/
      - inject:
          properties-content:
              !include-raw: .env.mobile-jobs
    scm:
      - git:
          branches:
            - '$GIT_ORIGIN_BRANCH'
          url: git@github.com:CruGlobal/{name}.git
          credentials-id: '66c3b5a3-0f7c-4e22-97b2-a78fb5a73658'
          refspec: '+refs/heads/develop:refs/remotes/origin/develop'
          wipe-workspace: false
          skip-tag: true
          prune: true
          excluded-users:
            - cru-jenkins-mobile
            - cru-jenkins2
            - cru-jenkins
    triggers:
      - github
    wrappers:
      - build-name:
          name: '$GIT_ORIGIN_BRANCH #$BUILD_NUMBER'
      - ssh-agent-credentials:
          users:
            - '66c3b5a3-0f7c-4e22-97b2-a78fb5a73658'
      - ansicolor:
          colormap: xterm
    builders:
      - shell:
          !include-raw: fastlane-modification-check.sh
      - shell: |
          bundle install
          bundle exec fastlane beta --env beta
    publishers:
      - html-publisher:
          name: "Unit Test Results"
          dir: "fastlane/output/unit_test_reports"
          files: "report.html"
          keep-all: true
          allow-missing: true
          link-to-last-build: false
      - html-publisher:
          name: "Code Coverage Results"
          dir: "fastlane/output/code_coverage_reports"
          files: "index.html"
          keep-all: true
          allow-missing: true
          link-to-last-build: false
      - junit:
          results: fastlane/report.xml
          keep-long-stdio: true
          health-scale-factor: 1.0
          allow-empty-results: true
      - email:
          recipients: '{email-recipients}'

- job-template:
    name: '{name}-production'
    node: mac
    logrotate:
      numToKeep: -1
    description: |
      {description-intro}

      Runs when pull requests are submitted to master branch. If building and testing is successful the app will be deployed to the appstore/playstore for you to review prior to submitting the app.
    properties:
      - github:
          url: https://github.com/CruGlobal/{name}/
      - inject:
          properties-content:
              !include-raw: .env.mobile-jobs
    scm:
      - git:
          branches:
            - '$GIT_ORIGIN_BRANCH'
          url: git@github.com:CruGlobal/{name}.git
          credentials-id: '66c3b5a3-0f7c-4e22-97b2-a78fb5a73658'
          refspec: '+refs/heads/master:refs/remotes/origin/master'
          wipe-workspace: false
          skip-tag: true
          prune: true
          excluded-users:
            - cru-jenkins-mobile
            - cru-jenkins2
            - cru-jenkins
    triggers:
      - github
    wrappers:
      - build-name:
          name: '$GIT_ORIGIN_BRANCH #$BUILD_NUMBER'
      - ssh-agent-credentials:
          users:
            - '66c3b5a3-0f7c-4e22-97b2-a78fb5a73658'
      - ansicolor:
          colormap: xterm
    builders:
      - shell:
          !include-raw: fastlane-modification-check.sh
      - shell: |
          bundle install
          bundle exec fastlane production --env production
    publishers:
      - html-publisher:
          name: "Screen Shots"
          dir: "fastlane/output/screenshots"
          files: "screenshots.html"
          keep-all: true
          allow-missing: true
          link-to-last-build: false
      - html-publisher:
          name: "Unit Test Results"
          dir: "fastlane/output/unit_test_reports"
          files: "report.html"
          keep-all: true
          allow-missing: true
          link-to-last-build: false
      - html-publisher:
          name: "Code Coverage Results"
          dir: "fastlane/output/code_coverage_reports"
          files: "index.html"
          keep-all: true
          allow-missing: true
          link-to-last-build: false
      - junit:
          results: fastlane/report.xml
          keep-long-stdio: true
          health-scale-factor: 1.0
          allow-empty-results: true
      - email:
          recipients: '{email-recipients}'